name: generate animation

on:
  schedule:
    - cron: "0 */24 * * *" 
    
  workflow_dispatch:
  
  push:
    branches:
    - main

jobs:
  generate:
    permissions: 
      contents: write
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: generate github-contribution-grid-snake.svg
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark
          
      - name: Update README with SVG
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const svgPath = './dist/github-contribution-grid-snake.svg';
            let svgContent = fs.readFileSync(svgPath, { encoding: 'utf8' });

            //  Заменяем цвет змейки и убираем прогресс-бар.
            //  Это нужно делать, потому что параметры URL не работают.
            svgContent = svgContent.replace(/#777777/g, '#00BFFF'); // Заменяем серый на голубой
            svgContent = svgContent.replace(/<rect .*?class="progress".*?\/>/g, ''); // Удаляем прогресс-бар

            const readmePath = 'README.md';
            let readmeContent = fs.readFileSync(readmePath, { encoding: 'utf8' });

            // Replace the snake section in README
            readmeContent = readmeContent.replace(
              /(<!-- github-snake-start -->[\s\S]*<!-- github-snake-end -->)/m,
              `<!-- github-snake-start -->\n<p align="center">\n${svgContent}\n</p>\n<!-- github-snake-end -->`
            );

            fs.writeFileSync(readmePath, readmeContent, { encoding: 'utf8' });

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: readmePath,
              message: 'Update README with new snake SVG',
              content: readmeContent,
              sha: (await github.rest.git.getRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'heads/main'
              })).data.object.sha,
              committer: {
                name: 'GitHub Actions Bot',
                email: 'actions@github.com'
              },
              author: {
                name: 'GitHub Actions Bot',
                email: 'actions@github.com'
              }
            });
      - name: push github-contribution-grid-snake.svg to the output branch
        uses: crazy-max/ghaction-github-pages@v3.1.0
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
